# Purpose:
#   Install composer dependencies for a Drupal application
#
# Configuration:
#   Adjust the needed artifact paths
#
build:php:
  extends: .base-build
  image:
    name: composer:${BUILD_COMPOSER_VERSION}
    pull_policy: if-not-present
  variables:
    COMPOSER_CACHE_DIR: '${PATH_CI_DIR}/.composer'
  cache:
    key: composer-$CI_JOB_NAME-$CI_COMMIT_REF_NAME
    paths:
      - ${PATH_CI_DIR}/.composer
      - ${PATH_APP_DIR}/vendor/
      - ${PATH_APP_DIR}/web/core/
      - ${PATH_APP_DIR}/web/modules/contrib/
      - ${PATH_APP_DIR}/web/themes/contrib/
      - ${PATH_APP_DIR}/web/libraries/
      - ${PATH_APP_DIR}/web/autoload.php
      - ${PATH_APP_DIR}/web/index.php
      - ${PATH_APP_DIR}/web/robots.txt
  artifacts:
    paths:
      - ${PATH_APP_DIR}/vendor/
      - ${PATH_APP_DIR}/web/core/
      - ${PATH_APP_DIR}/web/modules/contrib/
      - ${PATH_APP_DIR}/web/themes/contrib/
      - ${PATH_APP_DIR}/web/libraries/
      - ${PATH_APP_DIR}/web/autoload.php
      - ${PATH_APP_DIR}/web/index.php
      - ${PATH_APP_DIR}/web/robots.txt
  before_script:
    - composer config -g cache-dir "${PATH_CI_DIR}/.composer"
    - composer config -g github-oauth.github.com $BUILD_GITHUB_TOKEN -d ${PATH_CI_DIR}
  script:
    - composer install --ignore-platform-reqs --optimize-autoloader --no-ansi --no-interaction --no-progress --no-scripts -d ${PATH_APP_DIR}
